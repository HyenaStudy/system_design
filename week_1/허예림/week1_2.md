# Chapter 1 사용자 수에 따른 규모 확장성

### 단일 서버

1. 사용자의 도메인 접속
2.  DNS에 질의하여 실제 서버 IP 주소로 변환
3. 실제 서버 IP주소에 HTTP요청이 전달됨

### 수직적 규모 확장 VS 수평적 규모 확장

**수직적 규모 확장 (vertical scaling, scale up)**

- 서버에 고사양 자원을 추가하여 성능 개선
- 유입되는 양이 적을 때 고려해볼 만함
- 한대의 서버에 CPU나 메모리를 증설하는데는 한계가 있음
- 장애 발생 시 완전 중단 → 로드밸런서 + 수평적 규모 확장

**수평적 규모 확장 (scale out)**

- 더 많은 서버를 추가하여 성능 개선

**로드밸런서**

- 부하 분산 집합(load balancing set)에 속한 웹 서버들에게 트래픽 부하를 고르게 분산하는 역할
- 사설 ip 주소
    - 사용자는  로드밸런서의 공개 ip로 접속한다
    - 웹 서버는 클라이언트의 접속을 직접 처리하지 않느다.
    - 더 나은 보안을 위해 서버 간 통신에는 사설 ip 주소가 이용된다.
    - 사설 ip 주소는 같은 네트워크에 속한 서버 사이의 통신에만 쓰일 수 있는 ip주소로 인터넷을 통해서 접속할 수 없고, 로드밸런서는 웹 서버와 통신하기 위해 이 사설 주소를 이용한다.
- 로드 밸런서를 활용해 failover를 자동복구 할 수 있다.

### 데이터 베이스 다중화

- 보통은 서버 사이에 master-slave 관계를 설정하고 데이터 원본은 master에 사본은 slave 서버에 저장하는 방식이다.
- read-writre 동기화 이슈가 발생하는 원인
- master-slave 다중화 모델에서 모든 데이터 변경 연산은 master 서버로만 전달되는 반면 읽기 연산은 slave 데이터 베이스 서버들로 분산된다. 병렬로 처리될 수 있는 질의의 수가 늘어나므로 성능 향상

### 캐시

- 캐시는 값비싼 db 연산을 메모리 안에 두고 뒤이은 요청이 보다 빨리 처리되도록 한다
- 캐시를 두어 db 부하를 줄일 수 있고, 캐시 계층의 규모를 독립적으로 확장시키는 것도 가능하다.

**고려 사항**

- 어떤 상황에 적용하는 것이 적절한가? 데이터 갱신이 자주 일어나지 않지만 참조가 빈번한 경우
- 영속적으로 보관하지 않는 데이터 저장용
- 만료 시간은 어떻게 설정해야하나
- 일관성? 데이터 저장소의 원본과 캐시 간의 일관성
    - 참고 문헌 : Sacling Memcache at Facebook
    
- 장애 대처 방법 : 캐시 서버또한 한대만 존재하는 경우 Single Poing of Failre가 되어버릴 가능성 존재 → 캐시를 여러 지역에 걸쳐 분산시켜야 한다
- 캐시가 너무 작은 경우 너무 자주 캐시에 밀려나버려 성능이 떨어진다.
- 데이터 방출 : 캐시가 꽉 찼을 때 어떤 데이터 부터 보내야 하는거? 보통 LRU를 많이 쓴다.

### CDN

- 정적 콘텐츠를 전송하는 데 쓰이는 지리적으로 분산된 서버의 네트워크
- 사용자가 웹사이트에 방문하면 해당 사용자와 가장 가까운 cdn 서버가 정적 콘텐츠를 전달한다.

**고려사항**

- 적절한 만료 시간
- 장애 대처 방안

### 무상태 웹 계층

**상태 정보 의존적인 아키텍처**

scale out으로 서버가 나뉘어 있을 경우 a서버로 인증한 a 사용자의 요청은 무조건 a 서버로 요청되어야 한다. 이를 지원하기 위해 고정 세션이라는 기능을 제공한다. 고정 세션은 로드 밸런서에 부담을 주고 로드밸런서 뒷단에 서버를 추가하거나 제거하기 까다로워진다.

**무상태 아키텍처**

사용자의 요청이 어느 서버에서도 처리 가능하도록 공유 저장소를 둔다.

### 데이터 센터

지리적 라우팅 : geoDNS-routing : 장애가 없는 상황에서 사용자는 가장 가까운 데이터 센터로 안내된다.

- 트래픽 우회 : 올바른 데이터 센터로 트래픽을 보내는 효과적인 방법을 찾아야한다. GeoDNS는 사용자에게서 가장 가까운 데이터 센터로 트래픽을 보낼 수 있도록 해준다.
- 데이터 동기화 : 데이터 센터마다 별도의 데이터 베이스를 사용하고 있는 상황이라면 장애가 failover되어 트래픽이 다른 데이터 베이스로 우회한다해도, 해당 데이터 센터에는 찾는 데이터가 없을 수 있다.
    - 넷플릭스의 여러 데이터 베이스에 걸쳐 데이터를 어떻게 다중화 하는지 찾아보기
- 테스트와 배포: 여러데이터 센터를 사용하도록 시스템이 구성된 상황이라면 웹 사이트 또는 애플리케이션을 여러 위치에서 테스트 해보는 것도 중요하다.

### 메시지 큐

- 메시지의 무손실을 보장하는 비동기 통신을 지원하는 컴포넌트이다.
- 메시지 버퍼의 역할을 하며 비동기적으로 전송한다.
- 생산자(발행자)라고 불리는 입력 서비스가 메시지를 만들어 메시지 큐에 발행한다.
- 큐에 보통 소비자라고 불리는 서버 혹은 서비스가 연결되어 있는데 메시지를 받아 그에 맞는 동작을 소비한다.
- 메시지 큐를 이용하면 서비스또는 서버간의 결합이 느슨해져서 규모 확장성이 보장되어야 하는 안정적 애플리케이션을 구성하기 좋다. 생산자는 소비자 프로세스가 다운되어 있어도 메시지를 발행할 수 있고, 소비자는 생산자 서비스가 가용한 상태가 아니더라도 메시지를 수신할 수 있다.
- 사용 예 : 이미지의 크로핑, 샤프닝, 블러링을 지원하는 사진 보정 애플리케이션 생성 시 비동기적으로 처리하면 편하다.

### 데이터 베이스의 규모 확장

**수직적 확장**

- 기존 서버에 더많은 혹은 고성능의 자원을 증설하는 방법
    - 스택오버플로우는 2013년 한해동안 천만명의 사용자를 전부 단 하나의 데이터베이스로 처리하였다.
    - 데이터 베이스 서버 하드웨어는 한계가 있으므로 CPU RAM 등을 무한 증설할 수 없다. 사용자가 계속 늘어나면 한대 서버로는 결국 감당하기 ㅓㅇ렵게 된다.
    - 한대의 서버는 SPOF지점이다
    - 비용이 많이 든다

**수평적 확장**

- 샤딩 : 데이터 베이스를 샤드라고 부르는 작은 단위로 분할하는 기술을 일컫는다.
- 모든 샤드는 같은 스키마를 쓰지만 중복된 데이터는 없다.
- 샤딩 전략
    - 샤딩 키를 어떻게 정할 것인가? (==파티션키)
    - 데이터의 재샤딩
        - 데이터가 너무 많아져서 하나의 샤드로 더이상 감당하기 어려울때
        - 샤드 간 데이터 분포가 균등하지 못하여 어떤 샤드에 할당된 공간 소모가 다른 샤드에 비해 빨리 진행될때
        - 유명인사 : 특정 샤드에 질의가 집중되어 서버가과부하에 걸림ㅈ
        - 조인과 비정규화 : 하나의 데이터베이스를 여러 샤드 서버로 쪼개고 나면 여러 샤드에 걸친 데이터를 조인하기 힘들어진다.

# Chapter 2. 개략적인 규모 추정

**QPS**

- 1초 동안 서버가 처리하는 요청 수
1. DAU를 구한다.
    - MAU 3억중 50%가 매일 로그인한다. → DAU는 1.5
2. 하루 평균 2개의 트윗을 한다. → 총 3억개의 트윗
3. 3억 % 86400(하루) = 3500
4. 요청이 사람이 많을 때는 두배까지 뛰어오름 따랗서 피크일때는 7000
