# 처리율 제한 장치 설계

## 1. 문제 상황 확인
1. 서버 측의 처리율 제한 장치(rate limiter, **이하 rl**)를 설계해야 한다
2. 처리율 제한 규칙은 유연해야 한다
3. 대규모 트래픽에도 견고해야 한다
4. 분산 환경에서 동작해야 한다
5. 예외 처리가 필요하다

## 2. 구현 전제 조건
### (1) 직접 구현할 경우 - JVM 계열 언어가 적합한가?
**rl의 매커니즘은 동기/비동기, 블로킹/논블로킹을 고려하지 않는다**
- I/O 요청의 동기/비동기 처리나, 핸들러의 블로킹/논블로킹 여하에 관련없이 rl은 입장 허용 여부만 판별
- 매장 오픈 전 문 앞 손님들이 질서있게 있든, 마구잡이로 몰려있든 매장 입구컷의 적용은 동일한 것처럼

**JVM은 원자적 연산(CAS)에 매우 강력하다**
- rl은 대부분 원자적 카운팅(증감 연산) 기반의 알고리즘
- `Atomic` 시리즈, `Lock` 인터페이스 구현체, `Concurrent` 시리즈처럼 원자 연산을 지원하는 자료구조가 풍부함

**서버 아키텍처의 확장에 구애받지 않는다: 대규모 트래픽에도 견고한 rl 세팅 가능**
- 모놀리스라면 Spring MVC의 필터나 인터셉터 단에 자연스럽게 세팅 가능
- 분산 마이크로서비스로 확장하면 Spring Cloud의 API Gateway에 세팅하는 것 또한 가능
- 다만 스케일 아웃으로 분산 환경까지 다다르면 직접 구현만 하지 않고 외부 서비스와 결합된 rl 세팅이 더 자연스러워질 것

### (2) 외부 서비스를 빌릴 경우 - 선택 기준이 무엇인가?
**1번 고려사항과 2번 고려사항 일부분의 충돌**
- rl의 선택 기준은 **적용 위치**(엣지, 앱 내부)와 **적용 OSI 7계층**(L4, L7)
- 엣지는 CDN과 같이 클라이언트와 밀접한 영역에 rl을 세팅하는 것
- 현재 문제 상황의 **서버 측 설계**에 부합하지 않으므로 rl은 **앱 내부**에 세팅해야 한다
- 즉, **API 중심 처리율 제한 정책**을 적용할 것이므로 CDN 기반 rl, DDos 방어 기반 rl은 선택 논외사항
- 앱 내부를 기준으로 **적용 OSI 계층은 L7에 한정**된다. 즉 API 중심이 되므로 패킷 정보와 같은 처리율 제한 기준 폭이 줄어든다
- 하지만, **API 요청의 IP, 헤더 정보, 엔드포인트 혹은 메소드 등 충분히 다양한 기준을 충족**할 수 있음
- 그러므로 Cloudflare 같은 엣지 기반 rl 서비스는 배제

**서버의 환경 고려**
- 4번 고려사항에 따라 서버는 분산 환경을 상정하게 됨
- 모놀리스는 rl 배치 레이어 선택지가 적은 편
  - 필터, 인터셉터 : `Bucket4j`
  - 컨트롤러
  - AOP
  - 프록시 서버(외부 rl 가능) : `NGINX Plus`
- 분산 환경(MSA)까지 나아가면 rl 배치 레이어 선택지는 다양하게 늘어남
  - API Gateway : `Spring Cloud Gateway` + `Bucket4j`
  - 서비스 메쉬(서비스 간 네트워크, 서비스 간 호출량 제한) : `Istio`
  - 사이드카(서비스 개별 프록시, 각 서비스별 처리율 제한 정책) : `Envoy` + `Redis`
  - 기존 인 서비스 레이어

## 3. 처리율 제한 알고리즘
### (1) 토큰 버킷(token bucket)
0. 파라미터는 **버킷 사이즈**와 **초당 토큰 공급률(refill rate)**
1. 버킷에 토큰이 덜 채워지면 공급되고, 다 채워진 버킷에 공급되는 토큰은 버려짐(overflow)
2. 요청 처리당 토큰 하나가 소모되고, 토큰이 없는데 들어온 처리 요청은 버려짐(dropped)
### (2) 누출 버킷(leaky bucket)
0. 파라미터는 **버킷(큐) 사이즈**와 **처리율(outflow rate: 지정된 시간당 항목 처리 개수)**
1. 큐는 처리율에 따라 지정된 시간당 정해진 요청을 처리하고 해당 개수만큼 pop
2. 요청이 도달했을 때, 큐가 비어있으면 채워지고 큐가 가득 차있으면 요청은 버려짐
### (3) 고정 윈도우 카운터(fixed window counter)
### (4) 이동 윈도우 로그(sliding window log)
### (5) 이동 윈도우 카운터(sliding window counter)

## 4. 분산 환경 고려
